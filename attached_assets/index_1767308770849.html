<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Listado de Escuelas — DGE</title>
<style>
  /* =========================
     Diseño base (mobile-first)
     ========================= */
  :root{
    --brand:#0D304A;
    --brand-600:#114465;
    --bg:#F7F9FC;
    --card:#FFFFFF;
    --line:#E3E8EF;
    --head:#ECF0F4;
    --text:#1F2937;
    --muted:#6B7280;
    --radius:12px;
    --shadow:0 8px 30px rgba(16,24,40,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}

  header{position:sticky; top:0; z-index:900; background: var(--brand); color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; letter-spacing:.2px; position:relative;}
  .menu-btn{position:absolute; left:16px; background:transparent;border:2px solid #fff;color:#fff;font-size:14px;font-weight:700;cursor:pointer;padding:6px 18px;border-radius:999px;transition:all .25s ease;box-shadow:0 2px 6px rgba(0,0,0,.25);display:flex;align-items:center;gap:8px;}
  .menu-btn:hover{background:#fff;color:var(--brand);border-color:#fff;box-shadow:0 3px 10px rgba(0,0,0,.35);} 
  .menu-btn:focus{outline:2px solid #fff;outline-offset:2px;border-radius:8px}

  .container{margin-left:260px;margin-right:0;padding:20px 16px;width:calc(100% - 265px);} 
  h2{font-size:20px;margin:0 0 14px 0}

  /* Filtros responsivos */
  .filters{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:14px}
  .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:0 18px;min-height:44px;display:flex;align-items:center;box-shadow:none;font-weight:600;gap:6px}
  .control{background:#fff;border:1px solid var(--line);border-radius:999px;padding:0 18px;min-height:44px;height:44px;display:flex;align-items:center;width:100%;box-shadow:none;font-weight:500}
  .filters > .pill{flex:0 0 auto;}
  .filters > input.control{flex:1 1 auto; min-width:200px;}
  .filters > select.control{flex:0 0 200px; min-width:160px;}
  select.control{appearance:none;background:#fff;border:1px solid var(--line);border-radius:999px;padding:0 44px 0 18px;min-height:44px;height:44px;display:flex;align-items:center;width:100%;box-shadow:none;font-weight:500;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%236B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 14px center}

  /* Tabla / Lista responsiva */
  .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
  table{width:100%;border-collapse:collapse}
  thead th{background:var(--head);text-align:left;font-weight:600;padding:12px 14px;font-size:16px;border-bottom:1px solid var(--line)}
  tbody td{padding:12px 14px;border-bottom:1px solid var(--line)}
  tbody tr:hover{background:#FAFBFC}
  .empty{padding:22px 14px;color:var(--muted)}

  .exports{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
  .btn{border:0;border-radius:10px;background:var(--brand);color:#fff;padding:6px 12px;cursor:pointer;box-shadow:none;font-weight:600;font-size:14px;}
  .btn:active{transform:translateY(1px)}

  footer{font-size:12px;color:#667085;text-align:center;margin:22px 0}

  /* Backdrop compartido */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:1000}
  .backdrop.show{opacity:1;pointer-events:auto}

  /* Barra lateral fija (denominaciones) */
  .drawer{position:fixed;top:0;left:0;height:100%;width:260px;background:var(--brand);color:#fff;border-right:1px solid #0A2436;box-shadow:10px 0 30px rgba(0,0,0,.25);transform:none;transition:none;z-index:1001;display:flex;flex-direction:column;}
  .drawer-header{background:#0D304A;color:#fff;padding:14px;display:flex;align-items:center;justify-content:center}
  .drawer-content{padding:14px;overflow-y:auto;flex:1;scroll-behavior:smooth;}
  .denom-list{list-style:none;margin:0;padding:0}
  .denom-list li{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer;border-radius:8px;background:#E5F2FA;color:#0D304A;margin-bottom:6px;transition:background .25s ease,color .25s ease;}
  .denom-list li.active{background:#56B4C6;color:#fff;font-weight:600;border-left:4px solid #ffffff;padding-left:6px;}
  .denom-list li:hover{background:#cde7f3;color:#0D304A;}

  /* Drawer inferior (detalles) adaptable al ancho del contenido */
  .detail-drawer{position:fixed;bottom:0;left:260px;width:calc(100% - 260px);background:#F2F3F5;border-radius:16px 16px 0 0;box-shadow:0 -8px 30px rgba(0,0,0,.15);transform:translateY(100%);transition:transform .45s cubic-bezier(.25,.8,.25,1);z-index:1100;max-height:85vh;display:flex;flex-direction:column;padding:0;border:none;}
  .detail-drawer.open{transform:translateY(0)}
  .detail-header{padding:14px;background:#0D304A;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:12px;border-radius:16px 16px 0 0;}
  .detail-close{background:#D92D20;border:0;color:#fff;font-weight:700;padding:8px 12px;border-radius:10px;cursor:pointer}
  .detail-content{padding:15px;overflow-y:auto;background:#E5E7EB;}
  .detail-grid{display:grid;grid-template-columns:1fr;gap:20px;margin-bottom:20px}
  .card{border:none;border-radius:14px;padding:18px 20px;background:#fff;box-shadow:none;}
  .card h3{ text-align:center;margin:0 0 14px 0;font-size:16px;text-transform:uppercase;letter-spacing:.5px;font-weight:700;color:var(--brand);padding:18px 14px;border-radius:8px;border-bottom:none;background:transparent;}
  .detail-field{margin:12px 0;padding:8px 12px;border-radius:6px;background:#ECEFF1;line-height:1.4;}
  .detail-field b{display:block;color:var(--brand);margin-bottom:4px;font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:.4px;}

  /* =========================
     Breakpoints (>= 640px)
     ========================= */
  @media (min-width:640px){
    .detail-grid{grid-template-columns:repeat(2,1fr);}    
    .container{padding:24px 16px}
    h2{font-size:22px}
    .filters{flex-wrap:nowrap;justify-content:flex-start}
    .control{width:200px}
    .exports{grid-template-columns:auto auto}
  }

  /* =========================
     Breakpoints (>= 920px)
     ========================= */
  @media (min-width:920px){
    .container{padding:28px 16px}
    h2{font-size:24px}
    .filters{gap:14px;flex-wrap:nowrap;justify-content:flex-start}
    .pill{margin-right:8px}
    .control{width:240px}
  }

  /* =========================
     Tabla → Tarjetas en mobile
     ========================= */
  @media (max-width:920px){
    thead{display:none}
    table, tbody, tr, td{display:block;width:100%}
    tbody tr{background:#fff;border:1px solid var(--line);border-radius:12px;margin:10px 0;overflow:hidden;box-shadow:var(--shadow)}
    tbody td{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line)}
    tbody td:last-child{border-bottom:0}
    td::before{content:attr(data-label);font-weight:600;color:var(--muted)}
    .btn{width:100%}
  }

  .detail-actions .btn-detail{background:#56B4C6!important;color:#fff!important;border:2px solid #56B4C6!important;border-radius:10px;padding:18px 16px;font-weight:600;transition:all .2s ease;}
  .detail-actions .btn-detail:hover{background:#3da4b7!important;color:#fff!important;border-color:#3da4b7!important;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.12);}  
  .menu-btn::before{content:"≡";font-size:18px;line-height:1;display:block;}
#btnCsv, #btnPdf { background:#56B4C6 !important; border-radius:999px !important; padding:6px 10px !important; font-size:13px !important; font-weight:600 !important; }
#btnCsv:hover, #btnPdf:hover { background:#3da4b7 !important; }
</style>
</head>
<body>
  <header>
    <button id="menuBtn" class="menu-btn" aria-label="Abrir menú">MENU</button>
    <div style="display:flex; flex-direction:column; margin-left:16px; color:#fff; line-height:1.2; font-weight:600; font-size:15px;">
      <span>Dirección Gestión Educativa</span>
      <span style="font-weight:400; opacity:.9; font-size:14px;">Establecimientos Estatales</span>
    </div>
  </header>

  <main class="container">
    <h2 id="pageTitle">Listado de Escuelas</h2>

    <section class="filters" aria-label="Filtros">
      <div style="font-size:14px;color:var(--muted);margin-right:12px;white-space:nowrap;">Seleccione una denominación para filtrar la tabla.</div>
      <span id="totalPill" class="pill">Total: 0</span>
      <input id="searchInput" class="control" type="search" placeholder="Buscar por Nº o Nombre" aria-label="Buscar por Nº o Nombre" />
      <select class="control" aria-label="Filtrar por región">
        <option>Todas las regiones</option>
      </select>
      <select class="control" aria-label="Filtrar por categoría">
        <option>Todas las categorías</option>
      </select>
    </section>

    <section class="table-wrap" role="region" aria-label="Tabla de escuelas">
      <table>
        <thead>
          <tr>
            <th>Región</th>
            <th>Categoría</th>
            <th>Denominación</th>
            <th>Número</th>
            <th>Nombre</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6" class="empty">Cargando...</td></tr>
        </tbody>
      </table>
    </section>

    <div class="exports">
      <button class="btn" type="button" id="btnCsv">Exportar CSV</button>
      <button class="btn" type="button" id="btnPdf">Exportar PDF</button>
    </div>

    <footer>
      © 2025 Dirección Gestión Educativa. Ministerio de Educación de la Provincia de San Luis.
    </footer>
  </main>

  <!-- Barra lateral fija (DENOMINACIONES) -->
  <aside id="drawer" class="drawer" role="complementary" aria-labelledby="drawerTitle">
    <div class="drawer-header">
      <img src="LOGO BLANCO.png" alt="Ministerio de Educación" style="height:28px; display:block; margin:0 auto;" />
    </div>
    <div class="drawer-content">
      <div style="color:#EAF6FF; font-size:14px; margin:12px 0; line-height:1.4; text-align:left;">
        Seleccione una denominación para filtrar la tabla.
      </div>
      <ul id="denomList" class="denom-list" aria-label="Lista de denominaciones"></ul>
    </div>
  </aside>

  <!-- Drawer Inferior (DETALLES) -->
  <div id="detailBackdrop" class="backdrop" aria-hidden="true"></div>
  <div id="detailDrawer" class="detail-drawer" aria-modal="true" aria-hidden="true">
    <div class="detail-header">
      <img src="LOGO BLANCO.png" alt="Logo Ministerio" style="height:22px;opacity:.95" />
      <button id="detailClose" class="detail-close" aria-label="Cerrar">Cerrar</button>
    </div>
    <div class="detail-content" id="detailContent">
      <div class="detail-actions" style="display:flex;gap:10px;margin-bottom:16px;">
        <button class="btn-detail" id="btnMatricula" style="flex:1;">Ver Matrícula</button>
        <button class="btn-detail" id="btnPof" style="flex:1;">Ver POF</button>
      </div>
      <!-- contenido dinámico -->
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- App script -->
  <script>
  // ====== Config Supabase ======
  if(!localStorage.getItem('usuario_actual')){
    localStorage.setItem('usuario_actual','Manuel Ponce');
  }
  const SUPABASE_URL = "https://csbcfhwdpstnofvsfqwh.supabase.co";
  const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYmNmaHdkcHN0bm9mdnNmcXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjkzODcsImV4cCI6MjA3MTcwNTM4N30.lX166U64tFeqKd6snFduL-oXWD_LXwzPMyQYVF3g8ek";

  // ====== Elementos ======
  const drawer = document.getElementById('drawer');
  const detailDrawer = document.getElementById('detailDrawer');
  const detailBackdrop = document.getElementById('detailBackdrop');
  const detailClose = document.getElementById('detailClose');
  const detailContent = document.getElementById('detailContent');
  const tableBody = document.getElementById('tableBody');
  const totalPill = document.getElementById('totalPill');
  const searchInput = document.getElementById('searchInput');
  const menuBtn = document.getElementById('menuBtn'); // conservado por compatibilidad
  const denomList = document.getElementById('denomList');

  // ====== Funciones de UI (drawer lateral es fijo; open/close no afectan) ======
  function openDrawer(){ /* barra fija: sin acción */ }
  function closeDrawer(){ /* barra fija: sin acción */ }

  // Debounce para búsquedas (mejor UX en mobile)
  function debounce(fn, delay=250){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
  }

  // ====== Data fetch tabla ======
  async function loadData({denominacion="", query=""}={}){
    try{
      let url = `${SUPABASE_URL}/rest/v1/establecimientos_datos_completos?select=*`;
      if(denominacion && denominacion!=='__ALL__'){ url += `&denominacion=eq.${encodeURIComponent(denominacion)}`; }
      if(query){
        const q = encodeURIComponent(`%${query}%`);
        url += `&or=(nro.ilike.${q},nombre.ilike.${q})`;
      }
      tableBody.innerHTML = `<tr><td colspan="6" class="empty">Cargando...</td></tr>`;
      const res = await fetch(url + '&order=nro.asc', {headers:{apikey:API_KEY,Authorization:`Bearer ${API_KEY}`}});
      if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error('Respuesta inválida');
      tableBody.innerHTML = data.length ? data.map(r=>`<tr data-nro="${r.nro??''}" data-cue_anexo="${r.cue_anexo??''}">
        <td data-label="Región">${r.region??''}</td>
        <td data-label="Categoría">${r.categoria??''}</td>
        <td data-label="Denominación">${r.denominacion??''}</td>
        <td data-label="Número">${r.nro??''}</td>
        <td data-label="Nombre">${r.nombre??''}</td>
        <td data-label="Acciones"><button class="btn">Ver Detalles</button></td>
      </tr>`).join("") : `<tr><td colspan="6" class="empty">Sin resultados</td></tr>`;
      totalPill.textContent = `Total: ${data.length}`;
    }catch(err){
      console.error(err);
      tableBody.innerHTML = `<tr><td colspan="6" class="empty">Error al cargar datos</td></tr>`;
    }
  }

  // ====== Denominaciones (click binding dinámico) ======
  let currentDenom = localStorage.getItem('selectedDenominacion') || "";
  function bindDenomClicks(){
    denomList.querySelectorAll('li').forEach(li=>{
      li.addEventListener('click',()=>{
        if(li.dataset.all !== undefined){
          currentDenom = '';
          localStorage.removeItem('selectedDenominacion');
        } else {
          currentDenom = li.textContent.trim();
          localStorage.setItem('selectedDenominacion', currentDenom);
        }
        denomList.querySelectorAll('li').forEach(x=>x.classList.remove('active'));
        li.classList.add('active');
        updateTitle(); loadData({denominacion:currentDenom, query:searchInput.value.trim()});
      });
    });
  }

  // ====== Búsqueda principal con debounce ======
  const onSearch = debounce(()=>{
    loadData({ query: searchInput.value.trim(), denominacion: currentDenom });
  }, 250);
  searchInput.addEventListener('input', onSearch);

  // ====== Carga denominaciones reales ======
  async function loadDenominaciones(){
    try{
      const url = `${SUPABASE_URL}/rest/v1/establecimientos_datos_completos?select=denominacion&order=denominacion.asc`;
      const res = await fetch(url, {headers:{apikey:API_KEY,Authorization:`Bearer ${API_KEY}`}});
      const raw = await res.json();
      const arr = Array.isArray(raw) ? raw : [];
      const values = [...new Set(arr.map(d=>d && d.denominacion).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      denomList.innerHTML = `<li data-all>Todos</li>` + values.map(v=>`<li>${v}</li>`).join('');
      bindDenomClicks();
    }catch(err){
      console.error('Error cargando denominaciones:', err);
      denomList.innerHTML = '<li style="color:#b91c1c">Error al cargar denominaciones</li>';
    }
  }

  function updateTitle(){
    const title=document.getElementById('pageTitle');
    if(!currentDenom){ title.textContent='Listado de Establecimientos'; return; }
    title.textContent='Listado de ' + currentDenom.charAt(0)+currentDenom.slice(1).toLowerCase();
  }

  // ====== Inicialización ======
  loadDenominaciones().then(()=>{
    if(currentDenom){
      const li = Array.from(denomList.querySelectorAll('li')).find(x=>x.textContent.trim()===currentDenom);
      if(li){ li.classList.add('active'); }
      loadData({denominacion:currentDenom});
    } else {
      updateTitle(); loadData();
    }
  });

  // ====== Drawer inferior (detalles) ======
  function openDetail(){ detailDrawer.classList.add('open'); detailBackdrop.classList.add('show'); }
  function closeDetail(){ detailDrawer.classList.remove('open'); detailBackdrop.classList.remove('show'); }
  detailBackdrop.addEventListener('click', closeDetail);
  detailClose.addEventListener('click', closeDetail);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDetail(); });

  // Delegación click "Ver Detalles"
  tableBody.addEventListener('click', async (e)=>{
    if(e.target.tagName === 'BUTTON' && e.target.textContent.includes('Ver Detalles')){
      const tr = e.target.closest('tr');
      const cue = (tr?.dataset?.cue_anexo || '').trim();
      let url = `${SUPABASE_URL}/rest/v1/establecimientos_datos_completos?select=*&cue_anexo=eq.${encodeURIComponent(cue)}`;
      try{
        const res = await fetch(url, {headers:{apikey:API_KEY,Authorization:`Bearer ${API_KEY}`}});
        const data = await res.json();
        const r = Array.isArray(data) ? data[0] : null;
        detailContent.innerHTML = r ? `
          <div class="detail-actions" style="display:flex;gap:10px;margin-bottom:16px;">
            <button class="btn-detail" id="btnMatricula" style="flex:1;">Ver Matrícula</button>
            <button class="btn-detail" id="btnPof" style="flex:1;">Ver POF</button>
          </div>
          <div class="detail-grid">
            <div class="card">
              <h3>Información General</h3>
              <div class='detail-field'><b>Nombre</b>${r.nombre ?? ''}</div>
              <div class='detail-field'><b>Denominación</b>${r.denominacion ?? ''}</div>
              <div class='detail-field'><b>Número</b>${r.nro ?? ''}</div>
              <div class='detail-field'><b>CUE</b>${r.cue ?? ''}</div>
              <div class='detail-field'><b>CUE Anexo</b>${r.cue_anexo ?? ''}</div>
              <div class='detail-field'><b>Sector</b>${r.sector ?? ''}</div>
              <div class='detail-field'><b>Categoría</b>${r.categoria ?? ''}</div>
              <div class='detail-field'><b>Ámbito</b>${r.ambito ?? ''}</div>
              <div class='detail-field'><b>Niveles</b>${r.niveles ?? ''}</div>
            </div>
            <div class="card">
              <h3>Ubicación</h3>
              <div class='detail-field'><b>Región</b>${r.region ?? ''}</div>
              <div class='detail-field'><b>Localidad</b>${r.localidad ?? ''}</div>
              <div class='detail-field'><b>Departamento</b>${r.departamento ?? ''}</div>
              <div class='detail-field'><b>Dirección</b>${r.direccion ?? ''}</div>
              <div class='detail-field'><b>Código Postal</b>${r.cp ?? ''}</div>
            </div>
            <div class="card">
              <h3>Contacto</h3>
              <div class='detail-field'><b>Teléfono</b>${r.telefono ?? ''}</div>
              <div class='detail-field'><b>Internos</b>${r.internos ?? ''}</div>
              <div class='detail-field'><b>Email Establecimiento</b>${r.mail_establecimiento ?? ''}</div>
            </div>
            <div class="card">
              <h3>Dirección</h3>
              <div class='detail-field'><b>Director/a</b>${r.director ?? ''}</div>
              <div class='detail-field'><b>DNI Director/a</b>${r.dni ?? ''}</div>
              <div class='detail-field'><b>Teléfono Director/a</b>${r.telefono_director ?? ''}</div>
              <div class='detail-field'><b>Email Director/a</b>${r.mail_director ?? ''}</div>
            </div>
            <div class="card">
              <h3>Matrícula por Nivel</h3>
              <div class='detail-field'><b>Inicial</b>${r.inicial ?? ''} alumnos</div>
              <div class='detail-field'><b>Primario</b>${r.primario ?? ''} alumnos</div>
              <div class='detail-field'><b>Secundario</b>${r.secundario ?? ''} alumnos</div>
            </div>
          </div>
        ` : '<p style="padding:16px;">Sin datos detallados.</p>';
        openDetail();
        setTimeout(()=>{
          const mBtn = document.getElementById('btnMatricula');
          const pBtn = document.getElementById('btnPof');
          if(mBtn){ mBtn.onclick = ()=> generarPDFMatricula(r.cue); }
          if(pBtn){ pBtn.onclick = ()=> generarPDFPof(r.cue); }
        },0);
      }catch(err){ console.error('Error cargando detalle:', err); }
    }
  });

  // ====== Tests mínimos (sanity) ======
  try {
    console.assert(typeof openDrawer === 'function', 'openDrawer debe ser función');
    console.assert(typeof closeDrawer === 'function', 'closeDrawer debe ser función');
    console.assert(typeof debounce === 'function', 'debounce debe ser función');
    console.assert(document.getElementById('menuBtn') !== null, 'menuBtn debe existir');
    console.assert(document.getElementById('tableBody') !== null, 'tableBody debe existir');
    // Nuevo test: denomSearch puede ser null si no existe
    const _ds = document.getElementById('denomSearch');
    console.assert(_ds === null || _ds instanceof HTMLElement, 'denomSearch debe ser null o un elemento');
  } catch (e) { console.warn('Tests básicos fallaron:', e); }

  // === Funciones PDF Matrícula ===
  async function fetchMatricula(cue){
    const url = `${SUPABASE_URL}/rest/v1/matricula?select=*&cue=eq.${encodeURIComponent(cue)}`;
    const res = await fetch(url,{headers:{apikey:API_KEY,Authorization:`Bearer ${API_KEY}`}});
    return await res.json();
  }
  function agruparMatricula(data){
    const grupos={};
    data.forEach(row=>{
      const nivel=row.nivel||'SIN NIVEL';
      if(!grupos[nivel]) grupos[nivel]={};
      const ec=row.estructura_curricular||'SIN ESTRUCTURA';
      if(!grupos[nivel][ec]) grupos[nivel][ec]=[];
      grupos[nivel][ec].push({grado:row.grado_año,seccion:row.seccion,turno:row.turno,matricula:row.matricula});
    });
    return grupos;
  }
  async function generarPDFMatricula(cue){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    const data=await fetchMatricula(cue);
    const grupos=agruparMatricula(data);
    let y=15;
    doc.setFont('Helvetica','bold');doc.setFontSize(14);
    doc.text('MATRÍCULA POR NIVEL',14,y); y+=10;
    Object.entries(grupos).forEach(([nivel,ecs])=>{
      doc.setFontSize(12); doc.text(`NIVEL: ${nivel}`,14,y); y+=8;
      Object.entries(ecs).forEach(([ec,items])=>{
        doc.setFontSize(11); doc.text(`Estructura Curricular: ${ec}`,14,y); y+=7;
        items.forEach(it=>{doc.setFont('Helvetica','normal');doc.setFontSize(10);
          doc.text(`${it.grado} — ${it.seccion} — ${it.turno} — Matrícula: ${it.matricula}`,18,y);
          y+=6;}); y+=6;}); y+=8;
    });
    doc.save('matricula.pdf');
  }
  function generarPDFPof(cue){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    doc.text('POF - Desarrollo pendiente',14,20);
    doc.save('pof.pdf');
  }

  // ===== Exportar CSV =====
  document.getElementById('btnCsv').addEventListener('click',()=>{
    const rows = Array.from(document.querySelectorAll('#tableBody tr'))
      .map(tr=>Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.replace(/\n/g,' ').trim()))
      .filter(cols=>cols.length>=5);
    const header = ['Región','Categoría','Denominación','Número','Nombre'];
    const csv = [header, ...rows].map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'listado.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  // ===== Exportar PDF Lista =====
  document.getElementById('btnPdf').addEventListener('click', async ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');

    const usuario = localStorage.getItem('usuario_actual') || 'Manuel Ponce';
    const fecha = new Date();
    const fechaStr = fecha.toLocaleDateString('es-AR');
    const horaStr = fecha.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
    const filtro = currentDenom || 'Todos';

    const drawBody = async () => {
      doc.setFontSize(10);
      doc.text(`Fecha: ${fechaStr}  Hora: ${horaStr}`, 20, 75);
      doc.text(`Usuario: ${usuario}`, 20, 90);
      doc.text(`Filtro aplicado: ${filtro}`, 20, 105);

      doc.setFontSize(14);
      doc.text('Listado de Establecimientos', 20, 130);

      const table = document.querySelector('.table-wrap');
      const canvas = await html2canvas(table, {scale:2});
      const imgData = canvas.toDataURL('image/png');
      const pageWidth = doc.internal.pageSize.getWidth();
      const imgWidth = pageWidth - 40;
      const imgHeight = canvas.height * imgWidth / canvas.width;
      doc.addImage(imgData, 'PNG', 20, 150, imgWidth, imgHeight);
      doc.save('listado.pdf');
    };

    try{
      const logo = new Image();
      logo.onload = ()=>{ doc.addImage(logo,'PNG',20,20,140,40); drawBody(); };
      // (placeholder) coloca tu base64 o ruta real
      logo.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAiAAAAA8CAYAAABl2b2mAAAACXBIWXMAAAsSAAALEgHS3X78AAAA';
    }catch(e){
      await drawBody();
    }
  });

  </script>
</body>
</html>

